{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Root",
  "type": "object",
  "oneOf": [
    {
      "type": "object",
      "required": [
        "postgres"
      ],
      "properties": {
        "postgres": {
          "$ref": "#/definitions/Postgres"
        }
      },
      "additionalProperties": false
    },
    {
      "type": "object",
      "required": [
        "file_system"
      ],
      "properties": {
        "file_system": {
          "$ref": "#/definitions/FileSystem"
        }
      },
      "additionalProperties": false
    }
  ],
  "properties": {
    "api_peer": {
      "default": null,
      "anyOf": [
        {
          "$ref": "#/definitions/ApiPeer"
        },
        {
          "type": "null"
        }
      ]
    },
    "api_public": {
      "default": null,
      "anyOf": [
        {
          "$ref": "#/definitions/ApiPublic"
        },
        {
          "type": "null"
        }
      ]
    },
    "auth": {
      "default": null,
      "anyOf": [
        {
          "$ref": "#/definitions/Auth"
        },
        {
          "type": "null"
        }
      ]
    },
    "cache": {
      "default": null,
      "anyOf": [
        {
          "$ref": "#/definitions/Cache"
        },
        {
          "type": "null"
        }
      ]
    },
    "clickhouse": {
      "default": null,
      "anyOf": [
        {
          "$ref": "#/definitions/ClickHouse"
        },
        {
          "type": "null"
        }
      ]
    },
    "guard": {
      "default": null,
      "anyOf": [
        {
          "$ref": "#/definitions/Guard"
        },
        {
          "type": "null"
        }
      ]
    },
    "kafka": {
      "default": null,
      "anyOf": [
        {
          "$ref": "#/definitions/Kafka"
        },
        {
          "type": "null"
        }
      ]
    },
    "logs": {
      "default": null,
      "anyOf": [
        {
          "$ref": "#/definitions/Logs"
        },
        {
          "type": "null"
        }
      ]
    },
    "metrics": {
      "default": {
        "host": null,
        "port": null
      },
      "allOf": [
        {
          "$ref": "#/definitions/Metrics"
        }
      ]
    },
    "pegboard": {
      "default": null,
      "anyOf": [
        {
          "$ref": "#/definitions/Pegboard"
        },
        {
          "type": "null"
        }
      ]
    },
    "runtime": {
      "default": {
        "allow_version_rollback": null,
        "force_shutdown_duration": null,
        "guard_shutdown_duration": null,
        "worker_cpu_max": null,
        "worker_shutdown_duration": null
      },
      "allOf": [
        {
          "$ref": "#/definitions/Runtime"
        }
      ]
    },
    "telemetry": {
      "default": {
        "enabled": true
      },
      "allOf": [
        {
          "$ref": "#/definitions/Telemetry"
        }
      ]
    },
    "topology": {
      "default": null,
      "anyOf": [
        {
          "$ref": "#/definitions/Topology"
        },
        {
          "type": "null"
        }
      ]
    }
  },
  "additionalProperties": false,
  "definitions": {
    "ApiPeer": {
      "description": "Configuration for the private API service.",
      "type": "object",
      "properties": {
        "host": {
          "type": [
            "string",
            "null"
          ],
          "format": "ip"
        },
        "port": {
          "type": [
            "integer",
            "null"
          ],
          "format": "uint16",
          "minimum": 0.0
        }
      },
      "additionalProperties": false
    },
    "ApiPublic": {
      "description": "Configuration for the public API service.",
      "type": "object",
      "properties": {
        "respect_forwarded_for": {
          "description": "Flag to respect the X-Forwarded-For header for client IP addresses.\n\nWill be ignored in favor of CF-Connecting-IP if DNS provider is configured as Cloudflare.",
          "type": [
            "boolean",
            "null"
          ]
        },
        "verbose_errors": {
          "description": "Flag to enable verbose error reporting.",
          "type": [
            "boolean",
            "null"
          ]
        }
      },
      "additionalProperties": false
    },
    "Auth": {
      "type": "object",
      "required": [
        "admin_token"
      ],
      "properties": {
        "admin_token": {
          "$ref": "#/definitions/Secret<String>"
        }
      },
      "additionalProperties": false
    },
    "Cache": {
      "description": "Configuration for the cache layer.",
      "type": "object",
      "required": [
        "driver"
      ],
      "properties": {
        "driver": {
          "$ref": "#/definitions/CacheDriver"
        }
      },
      "additionalProperties": false
    },
    "CacheDriver": {
      "type": "string",
      "enum": [
        "redis",
        "in_memory"
      ]
    },
    "ClickHouse": {
      "type": "object",
      "required": [
        "http_url",
        "native_url",
        "username"
      ],
      "properties": {
        "http_url": {
          "description": "URL to the HTTP access port for ClickHouse.",
          "type": "string",
          "format": "uri"
        },
        "native_url": {
          "description": "URL to the native access port for ClickHouse.",
          "type": "string",
          "format": "uri"
        },
        "password": {
          "default": null,
          "anyOf": [
            {
              "$ref": "#/definitions/Secret<String>"
            },
            {
              "type": "null"
            }
          ]
        },
        "provision_users": {
          "default": {},
          "type": "object",
          "additionalProperties": {
            "$ref": "#/definitions/ClickHouseUser"
          }
        },
        "secure": {
          "default": false,
          "type": "boolean"
        },
        "username": {
          "type": "string"
        }
      },
      "additionalProperties": false
    },
    "ClickHouseUser": {
      "type": "object",
      "required": [
        "password",
        "role",
        "username"
      ],
      "properties": {
        "password": {
          "$ref": "#/definitions/Secret<String>"
        },
        "role": {
          "$ref": "#/definitions/ClickHouseUserRole"
        },
        "username": {
          "type": "string"
        }
      },
      "additionalProperties": false
    },
    "ClickHouseUserRole": {
      "type": "string",
      "enum": [
        "Admin",
        "Write",
        "ReadOnly"
      ]
    },
    "Datacenter": {
      "type": "object",
      "required": [
        "datacenter_label",
        "is_leader",
        "name",
        "peer_url",
        "public_url"
      ],
      "properties": {
        "datacenter_label": {
          "type": "integer",
          "format": "uint16",
          "minimum": 0.0
        },
        "is_leader": {
          "type": "boolean"
        },
        "name": {
          "type": "string"
        },
        "peer_url": {
          "description": "URL of the api-peer service",
          "type": "string",
          "format": "uri"
        },
        "proxy_url": {
          "description": "URL of the guard service that other datacenters can access privately. Goes to the same place as",
          "type": [
            "string",
            "null"
          ],
          "format": "uri"
        },
        "public_url": {
          "description": "Public origin that can be used to connect to this region.",
          "type": "string",
          "format": "uri"
        },
        "valid_hosts": {
          "description": "List of hosts that are valid to connect to this region with. This is used in regional endpoints to validate that incoming requests to this datacenter are going to a region-specific domain.\n\nIMPORTANT: Do not use a global origin that routes to multiple different regions. This will cause unpredictable behavior when requests are expected to go to a specific region.",
          "default": null,
          "type": [
            "array",
            "null"
          ],
          "items": {
            "type": "string"
          }
        }
      },
      "additionalProperties": false
    },
    "FileSystem": {
      "type": "object",
      "required": [
        "path"
      ],
      "properties": {
        "path": {
          "type": "string"
        }
      },
      "additionalProperties": false
    },
    "Guard": {
      "type": "object",
      "properties": {
        "host": {
          "description": "Host for HTTP traffic",
          "type": [
            "string",
            "null"
          ],
          "format": "ip"
        },
        "https": {
          "description": "Enable & configure HTTPS",
          "anyOf": [
            {
              "$ref": "#/definitions/Https"
            },
            {
              "type": "null"
            }
          ]
        },
        "port": {
          "description": "Port for HTTP traffic",
          "type": [
            "integer",
            "null"
          ],
          "format": "uint16",
          "minimum": 0.0
        }
      },
      "additionalProperties": false
    },
    "Https": {
      "type": "object",
      "required": [
        "port",
        "tls"
      ],
      "properties": {
        "port": {
          "type": "integer",
          "format": "uint16",
          "minimum": 0.0
        },
        "tls": {
          "$ref": "#/definitions/Tls"
        }
      },
      "additionalProperties": false
    },
    "Kafka": {
      "type": "object",
      "required": [
        "ca_pem",
        "password",
        "url",
        "username"
      ],
      "properties": {
        "ca_pem": {
          "$ref": "#/definitions/Secret<String>"
        },
        "password": {
          "$ref": "#/definitions/Secret<String>"
        },
        "url": {
          "type": "string",
          "format": "uri"
        },
        "username": {
          "type": "string"
        }
      },
      "additionalProperties": false
    },
    "Logs": {
      "type": "object",
      "properties": {
        "redirect_logs_dir": {
          "default": null,
          "type": [
            "string",
            "null"
          ]
        }
      },
      "additionalProperties": false
    },
    "Memory": {
      "type": "object",
      "properties": {
        "channel": {
          "default": "default",
          "type": "string"
        }
      },
      "additionalProperties": false
    },
    "Metrics": {
      "description": "Configuration for the metrics service.",
      "type": "object",
      "properties": {
        "host": {
          "type": [
            "string",
            "null"
          ],
          "format": "ip"
        },
        "port": {
          "type": [
            "integer",
            "null"
          ],
          "format": "uint16",
          "minimum": 0.0
        }
      },
      "additionalProperties": false
    },
    "Nats": {
      "type": "object",
      "required": [
        "addresses"
      ],
      "properties": {
        "addresses": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "password": {
          "default": null,
          "anyOf": [
            {
              "$ref": "#/definitions/Secret<String>"
            },
            {
              "type": "null"
            }
          ]
        },
        "port": {
          "type": [
            "integer",
            "null"
          ],
          "format": "uint16",
          "minimum": 0.0
        },
        "username": {
          "default": null,
          "type": [
            "string",
            "null"
          ]
        }
      },
      "additionalProperties": false
    },
    "Pegboard": {
      "type": "object",
      "properties": {
        "actor_start_threshold": {
          "description": "How long to wait after creating and not receiving a starting state before setting actor as lost.\n\nUnit is in milliseconds.\n\n**Experimental**",
          "type": [
            "integer",
            "null"
          ],
          "format": "int64"
        },
        "actor_stop_threshold": {
          "description": "How long to wait after stopping and not receiving a stop state before setting actor as lost.\n\nUnit is in milliseconds.\n\n**Experimental**",
          "type": [
            "integer",
            "null"
          ],
          "format": "int64"
        },
        "base_retry_timeout": {
          "description": "Time to delay an actor from rescheduling after a rescheduling failure.\n\nUnit is in milliseconds.\n\n**Experimental**",
          "type": [
            "integer",
            "null"
          ],
          "format": "uint",
          "minimum": 0.0
        },
        "default_metadata_poll_interval": {
          "description": "Default metadata poll interval for serverless runners when not specified in runner config.\n\nUnit is in milliseconds.\n\n**Experimental**",
          "type": [
            "integer",
            "null"
          ],
          "format": "uint64",
          "minimum": 0.0
        },
        "hibernating_request_eligible_threshold": {
          "description": "How long after last ping before considering a hibernating request disconnected.\n\nUnit is in milliseconds.\n\n**Experimental**",
          "type": [
            "integer",
            "null"
          ],
          "format": "int64"
        },
        "min_metadata_poll_interval": {
          "description": "Minimum metadata poll interval for serverless runners.\n\nThe actual poll interval will be the maximum of this value and the runner config's `metadata_poll_interval` setting. This prevents excessive polling even if the runner config specifies a very short interval.\n\nUnit is in milliseconds.\n\n**Experimental**",
          "type": [
            "integer",
            "null"
          ],
          "format": "uint64",
          "minimum": 0.0
        },
        "pool_desired_max_override": {
          "description": "Global pool desired max.",
          "type": [
            "integer",
            "null"
          ],
          "format": "uint32",
          "minimum": 0.0
        },
        "reschedule_backoff_max_exponent": {
          "description": "Maximum exponent for the reschedule backoff calculation.\n\nThis controls the maximum backoff duration when rescheduling actors.\n\n**Experimental**",
          "type": [
            "integer",
            "null"
          ],
          "format": "uint",
          "minimum": 0.0
        },
        "retry_reset_duration": {
          "description": "How long an actor goes without retries before it's retry count is reset to 0, effectively resetting its backoff to 0.\n\nUnit is in milliseconds.\n\n**Experimental**",
          "type": [
            "integer",
            "null"
          ],
          "format": "int64"
        },
        "runner_eligible_threshold": {
          "description": "How long after last ping before considering a runner ineligible for allocation.\n\nUnit is in milliseconds.\n\n**Experimental**",
          "type": [
            "integer",
            "null"
          ],
          "format": "int64"
        },
        "runner_lost_threshold": {
          "description": "How long to wait after last ping before forcibly removing a runner from the database and deleting its workflow, evicting all actors.\n\nNote that the runner may still be running and can reconnect.\n\nUnit is in milliseconds.\n\n**Experimental**",
          "type": [
            "integer",
            "null"
          ],
          "format": "int64"
        },
        "runner_pool_consecutive_successes_to_clear_error": {
          "description": "Number of consecutive successes required to clear an active runner pool error.\n\nThis prevents a single success from clearing an error during flapping conditions. Higher values provide more stability but slower recovery from transient errors.\n\n**Experimental**",
          "type": [
            "integer",
            "null"
          ],
          "format": "uint32",
          "minimum": 0.0
        },
        "serverless_backoff_max_exponent": {
          "description": "Maximum exponent for the serverless backoff calculation.\n\nThis controls the maximum backoff duration when serverlessly connecting to runners.\n\n**Experimental**",
          "type": [
            "integer",
            "null"
          ],
          "format": "uint",
          "minimum": 0.0
        },
        "serverless_base_retry_timeout": {
          "description": "Time to delay a serverless runner from attempting a new outbound connection after a connection failure.\n\nUnit is in milliseconds.\n\n**Experimental**",
          "type": [
            "integer",
            "null"
          ],
          "format": "uint",
          "minimum": 0.0
        },
        "serverless_retry_reset_duration": {
          "description": "How long a serverless runner goes without connection failures before it's retry count is reset to 0, effectively resetting its backoff to 0.\n\nUnit is in milliseconds.\n\n**Experimental**",
          "type": [
            "integer",
            "null"
          ],
          "format": "int64"
        }
      },
      "additionalProperties": false
    },
    "Postgres": {
      "type": "object",
      "required": [
        "url"
      ],
      "properties": {
        "ssl": {
          "description": "SSL configuration options",
          "default": null,
          "anyOf": [
            {
              "$ref": "#/definitions/PostgresSsl"
            },
            {
              "type": "null"
            }
          ]
        },
        "unstable_disable_lock_customization": {
          "description": "UNSTABLE: Disable lock timeout customization\n\nWhen `false` (default), the driver sets `lock_timeout = '0'` and `deadlock_timeout = '10ms'` during transaction commits to optimize conflict detection.\n\nWhen `true`, these settings are NOT applied, which may be necessary for some PostgreSQL configurations or hosted services that don't support these settings.\n\n**This is an unstable feature and may change or be removed in future versions.**",
          "default": false,
          "type": "boolean"
        },
        "url": {
          "description": "URL to connect to Postgres with\n\nSupports standard PostgreSQL connection parameters including `sslmode`. Supported sslmode values: `disable`, `prefer` (default), `require`. To verify server certificates, use `sslmode=require` with `ssl.root_cert_path`.\n\nExample with sslmode: `postgresql://user:pass@host:5432/db?sslmode=require`\n\nSee: https://docs.rs/postgres/0.19.10/postgres/config/struct.Config.html#url",
          "allOf": [
            {
              "$ref": "#/definitions/Secret<String>"
            }
          ]
        }
      },
      "additionalProperties": false
    },
    "Postgres2": {
      "type": "object",
      "required": [
        "url"
      ],
      "properties": {
        "memory_optimization": {
          "default": true,
          "type": "boolean"
        },
        "ssl": {
          "description": "SSL configuration options",
          "default": null,
          "anyOf": [
            {
              "$ref": "#/definitions/PostgresSsl"
            },
            {
              "type": "null"
            }
          ]
        },
        "url": {
          "description": "URL to connect to Postgres with\n\nSupports standard PostgreSQL connection parameters including `sslmode`. Supported sslmode values: `disable`, `prefer` (default), `require`. To verify server certificates, use `sslmode=require` with `ssl.root_cert_path`.\n\nSee: https://docs.rs/postgres/0.19.10/postgres/config/struct.Config.html#url",
          "allOf": [
            {
              "$ref": "#/definitions/Secret<String>"
            }
          ]
        }
      },
      "additionalProperties": false
    },
    "PostgresSsl": {
      "type": "object",
      "properties": {
        "client_cert_path": {
          "description": "Path to the client certificate file\n\nUsed for client certificate authentication Equivalent to PostgreSQL's `sslcert` parameter",
          "default": null,
          "type": [
            "string",
            "null"
          ]
        },
        "client_key_path": {
          "description": "Path to the client private key file\n\nUsed for client certificate authentication Equivalent to PostgreSQL's `sslkey` parameter",
          "default": null,
          "type": [
            "string",
            "null"
          ]
        },
        "root_cert_path": {
          "description": "Path to the root certificate file for verifying the server's certificate\n\nRequired when using custom certificate authorities (e.g., Supabase) Equivalent to PostgreSQL's `sslrootcert` parameter",
          "default": null,
          "type": [
            "string",
            "null"
          ]
        }
      },
      "additionalProperties": false
    },
    "Runtime": {
      "type": "object",
      "properties": {
        "allow_version_rollback": {
          "description": "Whether or not to allow running the engine when the previous version that was run is higher than the current version.",
          "type": [
            "boolean",
            "null"
          ]
        },
        "force_shutdown_duration": {
          "description": "Time (in seconds) after which the engine process will forcibly exit after receiving SIGTERM. Must be greater than both worker_shutdown_duration and guard_shutdown_duration. Defaults to guard_shutdown_duration + 30 seconds.",
          "type": [
            "integer",
            "null"
          ],
          "format": "uint32",
          "minimum": 0.0
        },
        "guard_shutdown_duration": {
          "description": "Time (in seconds) to allow for guard to wait for pending requests after receiving SIGTERM. Defaults to 1 hour.",
          "type": [
            "integer",
            "null"
          ],
          "format": "uint32",
          "minimum": 0.0
        },
        "worker_cpu_max": {
          "description": "Adjusts worker curve around this value (in millicores, i.e. 1000 = 1 core). Is not a hard limit. When unset, uses /sys/fs/cgroup/cpu.max, and if that is unset uses total host cpu.",
          "type": [
            "integer",
            "null"
          ],
          "format": "uint",
          "minimum": 0.0
        },
        "worker_shutdown_duration": {
          "description": "Time (in seconds) to allow for the gasoline worker engine to stop gracefully after receiving SIGTERM. Defaults to 30 seconds.",
          "type": [
            "integer",
            "null"
          ],
          "format": "uint32",
          "minimum": 0.0
        }
      },
      "additionalProperties": false
    },
    "Secret<String>": {
      "type": "string"
    },
    "Telemetry": {
      "type": "object",
      "required": [
        "enabled"
      ],
      "properties": {
        "enabled": {
          "type": "boolean"
        }
      },
      "additionalProperties": false
    },
    "Tls": {
      "type": "object",
      "required": [
        "actor_cert_path",
        "actor_key_path",
        "api_cert_path",
        "api_key_path"
      ],
      "properties": {
        "actor_cert_path": {
          "type": "string"
        },
        "actor_key_path": {
          "type": "string"
        },
        "api_cert_path": {
          "type": "string"
        },
        "api_key_path": {
          "type": "string"
        }
      },
      "additionalProperties": false
    },
    "Topology": {
      "type": "object",
      "required": [
        "datacenter_label",
        "datacenters"
      ],
      "properties": {
        "datacenter_label": {
          "description": "Must be included in `datacenters`",
          "type": "integer",
          "format": "uint16",
          "minimum": 0.0
        },
        "datacenters": {
          "description": "List of all datacenters, including this datacenter.",
          "type": "array",
          "items": {
            "$ref": "#/definitions/Datacenter"
          }
        }
      },
      "additionalProperties": false
    }
  }
}