---
// This script handles copy button clicks for code blocks in MDX content
// Since Astro doesn't hydrate React components in MDX by default, we use vanilla JS
---

<script>
  // Use event delegation - only need one listener on document
  if (!(window as any).__copyCodeListenerAdded) {
    (window as any).__copyCodeListenerAdded = true;

    document.addEventListener('click', (event) => {
      const target = event.target as HTMLElement;
      const copyButton = target.closest('[data-copy-code]');

      if (!copyButton) return;

      // Find the code block - traverse up to find the container with .code
      let codeContainer: Element | null = null;
      let parent = copyButton.parentElement;

      // Walk up to find the code block container
      while (parent && !codeContainer) {
        codeContainer = parent.querySelector('.code');
        if (!codeContainer) {
          // Check for autofill container
          const autofill = parent.closest('[data-autofill-code]');
          if (autofill) {
            const code = autofill.getAttribute('data-autofill-code') || '';
            if (code) {
              navigator.clipboard.writeText(code).then(() => {
                window.dispatchEvent(new CustomEvent('rivet:copy-success'));
              });
            }
            return;
          }
        }
        parent = parent.parentElement;
      }

      if (codeContainer) {
        const code = codeContainer.textContent || '';
        if (code) {
          navigator.clipboard.writeText(code).then(() => {
            window.dispatchEvent(new CustomEvent('rivet:copy-success'));
          });
        }
      }
    });
  }
</script>
