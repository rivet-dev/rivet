---
import fs from 'node:fs/promises';
import path from 'node:path';
import MarketingLayout from '@/layouts/MarketingLayout.astro';
import { templates, TECHNOLOGIES, TAGS, type Template } from '@/data/templates/shared';
import { VanillaMarkdown } from '@/components/VanillaMarkdown';
import { TemplateCard } from '@/components/templates/TemplateCard';
import { Code } from '@/components/v2/Code';
import { Icon, faCloud, faGithub, faVercel } from '@rivet-gg/icons';

export async function getStaticPaths() {
	return templates.map((template) => ({
		params: { slug: template.name },
		props: { template },
	}));
}

const { template } = Astro.props;

async function getReadmeContent(templateName: string): Promise<string> {
	try {
		const readmePath = path.join(
			process.cwd(),
			'..',
			'examples',
			templateName,
			'README.md'
		);
		const content = await fs.readFile(readmePath, 'utf-8');
		return content;
	} catch (error) {
		console.error(`Failed to read README for ${templateName}:`, error);
		return '# README not found\n\nThe README for this template could not be loaded.';
	}
}

function getRelatedTemplates(template: Template): Template[] {
	const relatedTemplates = templates
		.filter((t) => {
			if (t.name === template.name) return false;
			return template.tags.some((tag) => t.tags.includes(tag));
		})
		.slice(0, 3);

	return relatedTemplates.length > 0
		? relatedTemplates
		: templates.filter((t) => t.name !== template.name).slice(0, 3);
}

function cleanReadmeContent(content: string): string {
	return content
		.replace(/^#\s+.+$/m, '')
		.replace(/^\n+/, '')
		.replace(/^.+?(?=\n\n|\n#)/s, '')
		.replace(/##\s+Getting Started[\s\S]*?(?=\n##|$)/, '')
		.replace(/##\s+License[\s\S]*$/, '')
		.trim();
}

const readmeContent = await getReadmeContent(template.name);
const cleanedReadmeContent = cleanReadmeContent(readmeContent);
const displayedRelated = getRelatedTemplates(template);
const githubUrl = `https://github.com/rivet-dev/rivet/tree/main/examples/${template.name}`;
const dashboardUrl = `https://dashboard.rivet.dev/new/${template.name}`;

// Strip markdown links from description
const description = template.description.replace(/\[([^\]]+)\]\([^)]+\)/g, '$1');
---

<MarketingLayout
	title={`${template.displayName} - Rivet Templates`}
	description={description}
	canonicalUrl={`https://rivet.dev/templates/${template.name}/`}
>
	<main class="min-h-screen bg-black font-sans text-zinc-300 selection:bg-[#FF4500]/30 selection:text-orange-200">
		<div class="relative overflow-hidden pb-12 pt-32 md:pt-48">
			<div class="mx-auto max-w-7xl px-6">
				<div class="max-w-2xl mb-12">
					<a href="/templates" class="inline-flex items-center gap-2 text-xs text-zinc-500 hover:text-white transition-colors mb-6">
						‚Üê Back to Templates
					</a>
					<h1 class="mb-6 text-4xl font-normal leading-[1.1] tracking-tight text-white md:text-6xl">
						{template.displayName}
					</h1>
					<p class="text-base leading-relaxed text-zinc-500">
						{description}
					</p>
				</div>

				{!template.noFrontend && (
					<div class="relative overflow-hidden rounded-lg border border-white/10 bg-zinc-900">
						<div class="flex items-center gap-2 border-b border-white/5 bg-white/5 px-4 py-3">
							<div class="flex gap-1.5">
								<div class="h-2.5 w-2.5 rounded-full bg-zinc-700"></div>
								<div class="h-2.5 w-2.5 rounded-full bg-zinc-700"></div>
								<div class="h-2.5 w-2.5 rounded-full bg-zinc-700"></div>
							</div>
						</div>
						<div class="relative w-full aspect-video">
							<img
								src={`/examples/${template.name}/image.png`}
								alt={template.displayName}
								width={1280}
								height={720}
								class="h-full w-full object-cover"
								loading="eager"
								decoding="async"
							/>
						</div>
					</div>
				)}
			</div>
		</div>

		<div class="border-t border-white/10 py-16">
			<div class="mx-auto max-w-7xl px-6">
				<div class="flex flex-col lg:flex-row gap-12">
					<div class="flex-1 lg:w-2/3">
						<article class="prose prose-invert prose-zinc max-w-none prose-headings:font-normal prose-headings:tracking-tight prose-p:text-zinc-400 prose-a:text-white prose-code:text-zinc-300">
							<VanillaMarkdown content={cleanedReadmeContent} client:load />
						</article>
					</div>

					<aside class="lg:w-72 flex-shrink-0">
						<div class="space-y-6">
							<div>
								<h3 class="text-xs font-medium uppercase tracking-wider text-zinc-500 mb-4">Get Started</h3>
								<div class="space-y-2">
									<a
										href={dashboardUrl}
										target="_blank"
										rel="noopener noreferrer"
										class="flex items-center gap-2 w-full rounded-md border border-white/10 px-4 py-2 text-sm text-zinc-300 hover:border-white/20 hover:text-white transition-colors"
									>
										<Icon icon={faCloud} className="text-sm" />
										Deploy
									</a>
									{template.providers.vercel && (
										<a
											href={template.providers.vercel.deployUrl}
											target="_blank"
											rel="noopener noreferrer"
											class="flex items-center gap-2 w-full rounded-md border border-white/10 px-4 py-2 text-sm text-zinc-300 hover:border-white/20 hover:text-white transition-colors"
										>
											<Icon icon={faVercel} className="text-sm" />
											Deploy with Vercel
										</a>
									)}
									<a
										href={githubUrl}
										target="_blank"
										rel="noopener noreferrer"
										class="flex items-center gap-2 w-full rounded-md border border-white/10 px-4 py-2 text-sm text-zinc-300 hover:border-white/20 hover:text-white transition-colors"
									>
										<Icon icon={faGithub} className="text-sm" />
										View on GitHub
									</a>
								</div>
							</div>

							<div class="border-t border-white/10 pt-6">
								<h3 class="text-xs font-medium uppercase tracking-wider text-zinc-500 mb-4">Run Locally</h3>
								<div class="rounded-lg border border-white/10 overflow-hidden">
									<Code
										language="bash"
										flush
										code={`git clone https://github.com/rivet-dev/rivet.git\ncd rivet/examples/${template.name}\nnpm install\nnpm run dev`}
										client:load
									/>
								</div>
							</div>

							<div class="border-t border-white/10 pt-6">
								<h3 class="text-xs font-medium uppercase tracking-wider text-zinc-500 mb-4">Technologies</h3>
								<div class="flex flex-wrap gap-2">
									{template.technologies.map((tech) => {
										const techInfo = TECHNOLOGIES.find((t) => t.name === tech);
										return (
											<span
												key={tech}
												class="rounded-full border border-white/10 px-3 py-1 text-xs text-zinc-400"
											>
												{techInfo?.displayName || tech}
											</span>
										);
									})}
								</div>
							</div>

							{template.tags.length > 0 && (
								<div class="border-t border-white/10 pt-6">
									<h3 class="text-xs font-medium uppercase tracking-wider text-zinc-500 mb-4">Tags</h3>
									<div class="flex flex-wrap gap-2">
										{template.tags.map((tag) => {
											const tagInfo = TAGS.find((t) => t.name === tag);
											return (
												<span
													key={tag}
													class="rounded-full border border-white/10 px-3 py-1 text-xs text-zinc-400"
												>
													{tagInfo?.displayName || tag}
												</span>
											);
										})}
									</div>
								</div>
							)}
						</div>
					</aside>
				</div>
			</div>
		</div>

		<div class="border-t border-white/10 py-16">
			<div class="mx-auto max-w-7xl px-6">
				<h2 class="text-2xl font-normal tracking-tight text-white mb-8">Related Templates</h2>
				<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
					{displayedRelated.map((relatedTemplate) => (
						<TemplateCard template={relatedTemplate} />
					))}
				</div>
			</div>
		</div>
	</main>
</MarketingLayout>
