---
import { getCollection } from 'astro:content';
import { getImage } from 'astro:assets';
import MarketingLayout from '@/layouts/MarketingLayout.astro';
import { RedesignedHero } from '@/components/marketing/sections/RedesignedHero';
import { BuiltInFeatures } from '@/components/marketing/sections/BuiltInFeatures';
import { ProblemSection } from '@/components/marketing/sections/ProblemSection';
import { CodeWalkthrough } from '@/components/marketing/sections/CodeWalkthrough';
import { HostingSection } from '@/components/marketing/sections/HostingSection';
import { IntegrationsSection } from '@/components/marketing/sections/IntegrationsSection';
import { ObservabilitySection } from '@/components/marketing/sections/ObservabilitySection';
import { RedesignedCTA } from '@/components/marketing/sections/RedesignedCTA';
import { ScrollObserver } from '@/components/ScrollObserver';

// Import thinking images
import imgThinker from '@/images/thinking/thinker.jpg';
import imgLadyWriting from '@/images/thinking/a_lady_writing_1962.10.1.jpg';
import imgPortrait from '@/images/thinking/portrait_of_a_man_possibly_jan_snoeck_1967.4.1.jpg';
import imgSaintMark from '@/images/thinking/saint_mark_2012.79.1.jpg';
import imgVirginReading from '@/images/thinking/the_virgin_reading_1939.1.354.jpg';
import imgThinkingOver from '@/images/thinking/thinking_it_over_2008.115.5135.jpg';
import imgWomanBalance from '@/images/thinking/woman_holding_a_balance_1942.9.97.jpg';
import imgThinking2 from '@/images/thinking/thinking2.jpg';
import imgThinking3 from '@/images/thinking/thinking3.jpg';
import imgThinking6 from '@/images/thinking/thinking6.jpg';
import img0000405625 from '@/images/thinking/0000405625_OG.JPG';
import imgCHSDM from '@/images/thinking/CHSDM-1946-9-1MattFlynn.jpg';
import imgNPG from '@/images/thinking/NPG-NPG_POB105.jpg';
import imgSAAM from '@/images/thinking/SAAM-1912.2.1_1.jpg';
import imgThink from '@/images/thinking/think.jpg';
import imgThink11 from '@/images/thinking/think11.jpg';
import imgThink12 from '@/images/thinking/think12.png';
import imgThinker6 from '@/images/thinking/thinker6.jpg';

// Optimize all thinking images
const thinkingImageSources = [
	{ src: imgThinker, title: 'The Thinker', artist: 'Auguste Rodin', date: 'modeled 1880' },
	{ src: imgLadyWriting, title: 'A Lady Writing', artist: 'Johannes Vermeer', date: 'c. 1665' },
	{ src: imgPortrait, title: 'Portrait of a Man (Possibly Jan Snoeck)', artist: 'Jan Gossaert', date: 'c. 1530' },
	{ src: imgSaintMark, title: 'Saint Mark', artist: 'Giorgio Vasari', date: '1570/1571' },
	{ src: imgVirginReading, title: 'The Virgin Reading', artist: 'Vittore Carpaccio', date: 'c. 1505' },
	{ src: imgThinkingOver, title: 'Thinking It Over', artist: 'Thomas Waterman Wood', date: '1884' },
	{ src: imgWomanBalance, title: 'Woman Holding a Balance', artist: 'Johannes Vermeer', date: 'c. 1664' },
	{ src: imgThinking2, title: 'Thinking Woman', artist: 'Abraham Ajay', date: 'c. 1935' },
	{ src: imgThinking3, title: 'The Writing Master', artist: 'Thomas Eakins', date: '1882' },
	{ src: imgThinking6, title: 'The Chess Players', artist: 'Thomas Eakins', date: '1876' },
	{ src: img0000405625, title: 'The Astronomer', artist: 'Johannes Vermeer', date: 'c. 1668' },
	{ src: imgCHSDM, title: 'The Interior of a Textile Factory', artist: 'Unknown artist', date: '1720-1750' },
	{ src: imgNPG, title: 'Patent Office, Model Room (Washington, D.C.)', artist: 'Unknown photographer', date: 'c. 1906' },
	{ src: imgSAAM, title: 'The Woodworker', artist: 'Eastman Johnson', date: '1877' },
	{ src: imgThink, title: 'Curiosity', artist: 'Gerard ter Borch the Younger', date: 'ca. 1660-62' },
	{ src: imgThink11, title: 'Alchemist Interior', artist: 'Unknown artist', date: '17th century' },
	{ src: imgThink12, title: 'Telephone Switchboard Operators', artist: 'Unknown photographer', date: 'c. 1940s' },
	{ src: imgThinker6, title: "A Scholar in His Study ('Faust')", artist: 'Rembrandt', date: 'ca. 1652' },
];

const optimizedThinkingImages = await Promise.all(
	thinkingImageSources.map(img =>
		getImage({
			src: img.src,
			width: 800,
			format: 'webp',
			quality: 80
		})
	)
);

const thinkingImages = optimizedThinkingImages.map((img, index) => ({
	src: img.src,
	title: thinkingImageSources[index].title,
	artist: thinkingImageSources[index].artist,
	date: thinkingImageSources[index].date,
}));

// Get latest changelog title
const posts = await getCollection('posts');
const changelogEntries = posts.filter((p) => p.data.category === 'changelog' && !p.data.unpublished);
const latest = changelogEntries.sort(
	(a, b) => b.data.published.getTime() - a.data.published.getTime()
)[0];

const latestChangelogTitle = latest?.data.title ?? '';
---

<MarketingLayout
	title="Rivet - Infrastructure for software that thinks."
	description="The primitive for software that thinks."
	canonicalUrl="https://rivet.dev"
	keywords={["actors", "stateful", "workflows", "websockets", "real-time", "backend infrastructure", "serverless", "open source", "self-hosted", "AI infrastructure", "long-running processes", "state management"]}
>
	<ScrollObserver client:load>
		<div class="min-h-screen bg-black font-sans text-zinc-300 selection:bg-[#FF4500]/30 selection:text-orange-200">
			<main>
				<RedesignedHero latestChangelogTitle={latestChangelogTitle} thinkingImages={thinkingImages} client:load />
				<BuiltInFeatures client:visible />
				<ProblemSection client:visible />
				<CodeWalkthrough client:visible />
				<IntegrationsSection client:visible />
				<ObservabilitySection client:visible />
				<HostingSection client:visible />
				<RedesignedCTA client:visible />
			</main>
		</div>
	</ScrollObserver>
</MarketingLayout>
