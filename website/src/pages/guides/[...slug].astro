---
import { getCollection, render } from 'astro:content';
import DocsLayout from '@/layouts/DocsLayout.astro';
import { DocsNavigation } from '@/components/DocsNavigation';
import { DocsTableOfContents } from '@/components/DocsTableOfContents';
import { DocsPageDropdown } from '@/components/DocsPageDropdown';
import { Prose } from '@/components/Prose';
import { Button } from '@rivet-gg/components';
import { Icon, faPencil } from '@rivet-gg/icons';
import { Comments } from '@/components/Comments';
import { sitemap } from '@/sitemap/mod';
import { findActiveTab } from '@/lib/sitemap';
import * as mdxComponents from '@/components/mdx';

export async function getStaticPaths() {
	const guides = await getCollection('guides');
	return guides.map((entry) => ({
		params: { slug: entry.id || undefined },
		props: { entry },
	}));
}

const { entry } = Astro.props;
const { Content, headings } = await render(entry);

// Build table of contents from headings
const tableOfContents = headings
	.filter((h) => h.depth === 2 || h.depth === 3)
	.reduce((acc, h) => {
		if (h.depth === 2) {
			acc.push({ title: h.text, id: h.slug, children: [] });
		} else if (acc.length > 0) {
			acc[acc.length - 1].children.push({ title: h.text, id: h.slug, children: [] });
		}
		return acc;
	}, [] as Array<{ title: string; id: string; children: Array<{ title: string; id: string; children: never[] }> }>);

const { title, description } = entry.data as { title: string; description: string };
const fullPath = `/guides/${entry.id}/`;
const foundTab = findActiveTab(fullPath, sitemap);
const parentPage = foundTab?.page?.parent;
const canonicalUrl = `https://rivet.gg${fullPath}`;

// Create markdown path for the dropdown
const markdownPath = `guides/${entry.id}`;
const componentSourcePath = `guides/${entry.id}.mdx`;

// Build OG image URL
const ogImage = `https://rivet.gg/og/guides/${entry.id}.png`;
---

<DocsLayout title={`${title} - Rivet`} description={description} canonicalUrl={canonicalUrl} ogImage={ogImage}>
	<aside class="hidden lg:block border-r">
		{foundTab?.tab?.sidebar && <DocsNavigation sidebar={foundTab.tab.sidebar} client:load />}
	</aside>
	<div class="flex justify-center w-full">
		<div class="flex gap-8 max-w-6xl w-full">
			<main class="w-full py-8 px-8 lg:mx-0 mx-auto max-w-prose lg:max-w-none">
				<div class="relative flex justify-end">
					<div class={`flex items-end md:absolute md:right-0 ${parentPage ? 'md:top-5' : 'md:top-0'}`}>
						<DocsPageDropdown
							title={title || 'Guide'}
							markdownPath={markdownPath}
							currentUrl={fullPath}
							client:load
						/>
					</div>
				</div>
				<Prose as="article" className="max-w-prose lg:max-w-prose mx-auto [&>h1:first-of-type]:pr-44">
					{parentPage && (
						<div class="eyebrow h-5 text-primary text-sm font-semibold">
							{parentPage.title}
						</div>
					)}
					<h1>{title}</h1>
					{description && <p>{description}</p>}
					<Content components={mdxComponents} />
				</Prose>
				<div class="border-t mt-8 mb-2"></div>
				<Button variant="ghost" asChild>
					<a
						href={`https://github.com/rivet-gg/rivet/edit/main/website/src/content/${componentSourcePath}`}
						target="_blank"
						rel="noreferrer"
					>
						<Icon icon={faPencil} className="mr-2" />
						Suggest changes to this page
					</a>
				</Button>
				<Comments client:load />
			</main>
			{tableOfContents.length > 0 && (
				<aside class="hidden xl:block w-64 min-w-0 flex-shrink-0 pb-4">
					<DocsTableOfContents className="lg:max-h-content" tableOfContents={tableOfContents} client:load />
				</aside>
			)}
		</div>
	</div>
</DocsLayout>
