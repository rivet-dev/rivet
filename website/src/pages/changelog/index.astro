---
import { getCollection } from 'astro:content';
import { Image } from 'astro:assets';
import BlogLayout from '@/layouts/BlogLayout.astro';
import { formatTimestamp } from '@/lib/formatDate';
import { AUTHORS, CATEGORIES } from '@/lib/article';

type AuthorInfo = {
	name: string;
	role: string;
	avatar: ImageMetadata;
	socials?: { twitter?: string; github?: string; bluesky?: string };
	url?: string;
};
import { AuthorAvatar } from '@/components/AuthorAvatar';
import { Icon, faRss } from '@rivet-gg/icons';

const posts = await getCollection('posts');

// Import all post images eagerly
const images = import.meta.glob<{ default: ImageMetadata }>(
	'/src/content/posts/*/image.{png,jpg,gif}',
	{ eager: true }
);

// Filter only changelog posts, exclude unpublished, and sort by date
const filteredPosts = posts
	.filter((post) => post.data.category === 'changelog' && !post.data.unpublished)
	.sort((a, b) => b.data.published.getTime() - a.data.published.getTime());

const changelogPosts = filteredPosts.map((post) => {
	const slug = post.id.replace(/\/page$/, '');
	const imagePath = Object.keys(images).find((p) => p.includes(slug));
	const image = imagePath ? images[imagePath].default : null;
	const author = AUTHORS[post.data.author] as AuthorInfo;
	const category = { ...CATEGORIES[post.data.category], id: post.data.category };
	const data = post.data as unknown as { title: string; description: string };

	return {
		...post,
		slug,
		image,
		author,
		category,
		title: data.title,
		description: data.description,
	};
});
---

<BlogLayout title="Changelog - Rivet">
	<div class="mx-auto mt-20 w-full max-w-7xl px-6 md:mt-32" style="--header-height: 5rem;">
		<div class="mt-8 flex w-full items-center justify-between">
			<h1 class="text-4xl font-normal leading-[1.1] tracking-tight text-white md:text-6xl">Changelog</h1>
			<a
				href="/rss/feed.xml"
				class="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md border border-white/10 px-4 py-2 text-sm text-zinc-300 transition-colors hover:border-white/20 hover:text-white"
			>
				<Icon icon={faRss} />
				RSS Feed
			</a>
		</div>
		<div class="mb-8 mt-6 flex items-center justify-start">
			<div class="flex gap-2">
				<a
					href="/blog/"
					class="inline-flex items-center justify-center whitespace-nowrap rounded-md border border-white/10 px-4 py-2 text-sm text-zinc-400 transition-colors hover:border-white/20 hover:text-white"
				>
					All Posts
				</a>
				<a
					href="/changelog/"
					class="inline-flex items-center justify-center whitespace-nowrap rounded-md bg-white px-4 py-2 text-sm font-medium text-black transition-colors hover:bg-zinc-200 selection-dark"
				>
					Changelog
				</a>
			</div>
		</div>
		<div class="mb-8 mt-8 grid grid-cols-1 gap-6 md:grid-cols-3">
			{changelogPosts.map((article) => (
				<a href={`/changelog/${article.slug}/`} class="size-full">
					<article class="flex size-full flex-col items-start justify-between rounded-md border border-white/10 p-4 transition-colors hover:border-white/20">
						<div>
							{article.image && (
								<div class="relative w-full">
									<Image
										src={article.image}
										alt={article.title}
										width={600}
										height={300}
										class="aspect-[2/1] w-full rounded-md border border-white/10 object-cover"
										loading="lazy"
										decoding="async"
									/>
								</div>
							)}
							<div class="mt-3 flex items-center gap-x-3 text-xs">
								<time datetime={article.data.published.toISOString()} class="text-zinc-500">
									{formatTimestamp(article.data.published)}
								</time>
								<span class="rounded-full border border-white/10 px-2 py-0.5 text-xs text-zinc-400">{article.category.name}</span>
							</div>
							<div class="group relative">
								<h3 class="mt-2 text-base font-normal leading-6 text-white">
									{article.title}
								</h3>
								<p class="mt-2 line-clamp-3 text-sm leading-relaxed text-zinc-500">
									{article.description}
								</p>
							</div>
						</div>
						<div class="max-w-xl">
							<div class="relative mt-4 flex items-center gap-x-3">
								<AuthorAvatar name={article.author.name} avatarSrc={article.author.avatar.src} client:load />
								<div class="text-sm text-zinc-400">
									{article.author.name}
								</div>
							</div>
						</div>
					</article>
				</a>
			))}
		</div>
	</div>
</BlogLayout>
