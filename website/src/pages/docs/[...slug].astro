---
import { getCollection, render } from 'astro:content';
import DocsLayout from '@/layouts/DocsLayout.astro';
import { DocsNavigation } from '@/components/DocsNavigation';
import { DocsTableOfContents } from '@/components/DocsTableOfContents';
import { DocsPageDropdown } from '@/components/DocsPageDropdown';
import { Prose } from '@/components/Prose';
import { Button } from '@rivet-gg/components';
import { Icon, faPencil } from '@rivet-gg/icons';
import { Comments } from '@/components/Comments';
import { sitemap } from '@/sitemap/mod';
import { findActiveTab } from '@/lib/sitemap';
import * as mdxComponents from '@/components/mdx';

export async function getStaticPaths() {
	const docs = await getCollection('docs');
	return docs.map((entry) => {
		// Handle index files - they should render at the parent path
		const slug = entry.id === 'index' ? undefined : entry.id.replace(/\/index$/, '') || undefined;
		return {
			params: { slug },
			props: { entry },
		};
	});
}

const { entry } = Astro.props;
const { Content, headings, remarkPluginFrontmatter } = await render(entry);

// Format last modified date
const lastModified = remarkPluginFrontmatter?.lastModified;
const lastModifiedFormatted = lastModified
	? new Date(lastModified).toLocaleDateString('en-US', {
			year: 'numeric',
			month: 'long',
			day: 'numeric',
		})
	: null;

// Build table of contents from headings
const tableOfContents = headings
	.filter((h) => h.depth === 2 || h.depth === 3)
	.reduce((acc, h) => {
		if (h.depth === 2) {
			acc.push({ title: h.text, id: h.slug, children: [] });
		} else if (acc.length > 0) {
			acc[acc.length - 1].children.push({ title: h.text, id: h.slug, children: [] });
		}
		return acc;
	}, [] as Array<{ title: string; id: string; children: Array<{ title: string; id: string; children: never[] }> }>);

// Get title from first h1 or frontmatter
const title = entry.data.title || headings.find((h) => h.depth === 1)?.text || 'Documentation';
const description = entry.data.description || '';
// Handle index paths correctly
const slugPath = entry.id === 'index' ? '' : entry.id.replace(/\/index$/, '');
const fullPath = slugPath ? `/docs/${slugPath}/` : '/docs/';
const foundTab = findActiveTab(fullPath, sitemap);
const parentPage = foundTab?.page?.parent;
const canonicalUrl = `https://rivet.gg${fullPath}`;

// Create markdown path for the dropdown
const markdownPath = `docs/${entry.id}`;
const componentSourcePath = `docs/${entry.id}.mdx`;
---

<DocsLayout title={`${title} - Rivet`} description={description} canonicalUrl={canonicalUrl}>
	<aside class="hidden lg:block border-r">
		{foundTab?.tab?.sidebar && <DocsNavigation sidebar={foundTab.tab.sidebar} client:load />}
	</aside>
	<div class="flex justify-center w-full">
		<div class="flex gap-8 max-w-6xl w-full">
			<main class="w-full py-8 px-8 lg:mx-0 mx-auto max-w-prose-docs lg:max-w-none">
				<div class="relative flex justify-end">
					<div class={`flex items-end md:absolute md:right-0 ${parentPage ? 'md:top-5' : 'md:top-0'}`}>
						<DocsPageDropdown
							title={title || 'Documentation'}
							markdownPath={markdownPath}
							currentUrl={fullPath}
							client:load
						/>
					</div>
				</div>
				<Prose as="article" className="max-w-prose-docs lg:max-w-prose-docs mx-auto [&>h1:first-of-type]:pr-44">
					{parentPage && (
						<div class="eyebrow h-5 text-primary text-sm font-semibold">
							{parentPage.title}
						</div>
					)}
					<Content components={mdxComponents} />
				</Prose>
				<div class="border-t mt-12 pt-6 flex flex-wrap items-center justify-between gap-4">
					<Button variant="outline" size="sm" asChild>
						<a
							href={`https://github.com/rivet-gg/rivet/edit/main/website/src/content/${componentSourcePath}`}
							target="_blank"
							rel="noreferrer"
						>
							<Icon icon={faPencil} />
							Edit this page
						</a>
					</Button>
					{lastModifiedFormatted && (
						<span class="text-xs text-muted-foreground">
							Last updated {lastModifiedFormatted}
						</span>
					)}
				</div>
				<Comments client:load />
			</main>
			{tableOfContents.length > 0 && (
				<aside class="hidden xl:block w-64 min-w-0 flex-shrink-0 pb-4">
					<DocsTableOfContents className="lg:max-h-content" tableOfContents={tableOfContents} client:load />
				</aside>
			)}
		</div>
	</div>
</DocsLayout>
