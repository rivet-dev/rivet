---
import { getCollection, render } from 'astro:content';
import LearnLayout from '@/layouts/LearnLayout.astro';
import * as mdxComponents from '@/components/mdx';

export async function getStaticPaths() {
	const learn = await getCollection('learn');
	return learn.map((entry) => {
		// Handle index files - they should render at the parent path
		const slug = entry.id === 'index' ? undefined : entry.id.replace(/\/index$/, '') || undefined;
		return {
			params: { slug },
			props: { entry },
		};
	});
}

const { entry } = Astro.props;
const { Content, headings } = await render(entry);

// Get title from first h1 or frontmatter
const title = entry.data.title || headings.find((h) => h.depth === 1)?.text || 'Learn';
const description = entry.data.description || '';

// Handle index paths correctly
const slugPath = entry.id === 'index' ? '' : entry.id.replace(/\/index$/, '');
const fullPath = slugPath ? `/learn/${slugPath}/` : '/learn/';
const canonicalUrl = `https://rivet.gg${fullPath}`;

// Determine if this is the index page
const isIndex = entry.id === 'index' || entry.id === 'index.mdx';

// Extract scene number from path (e.g., "scene-1-a-radically-simpler-architecture" -> "Scene 1")
const getSceneLabel = () => {
	const pathParts = slugPath.split('/');
	if (pathParts.length < 1) return '';
	const scenePart = pathParts[pathParts.length - 1];
	const sceneMatch = scenePart?.match(/scene-(\d+)/);
	return sceneMatch ? `Scene ${sceneMatch[1]}` : '';
};
const scene = getSceneLabel();

// Build table of contents from headings
const tableOfContents = headings
	.filter((h) => h.depth === 2 || h.depth === 3)
	.reduce((acc, h) => {
		if (h.depth === 2) {
			acc.push({ title: h.text, id: h.slug, children: [] });
		} else if (acc.length > 0) {
			acc[acc.length - 1].children.push({ title: h.text, id: h.slug });
		}
		return acc;
	}, [] as Array<{ title: string; id: string; children: Array<{ title: string; id: string }> }>);
---

<LearnLayout
	title={`${title} - Rivet`}
	description={description}
	canonicalUrl={canonicalUrl}
	act={entry.data.act}
	subtitle={entry.data.subtitle}
	tableOfContents={tableOfContents}
	isIndex={isIndex}
	scene={scene}
>
	<Content components={mdxComponents} />
</LearnLayout>
