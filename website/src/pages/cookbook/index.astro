---
import MarketingLayout from "@/layouts/MarketingLayout.astro";
import { getCollection } from "astro:content";
import { templates as allTemplates } from "@/data/templates/shared";
import { CookbookPageContent, type CookbookPageListItem } from "@/components/cookbook/CookbookPageContent";

const cookbook = await getCollection("cookbook");

const pages: CookbookPageListItem[] = cookbook
	.filter((entry) => entry.id !== "index")
	.map((entry) => {
		const cleanId = entry.id.replace(/\/index$/, "");
		const href = `/cookbook/${cleanId}/`;

		const templateNames = entry.data.templates ?? [];
		const resolved = templateNames.map((name) => {
			const t = allTemplates.find((x) => x.name === name);
			return {
				name,
				displayName: t?.displayName ?? name,
				template: t,
			};
		});

		const primary = resolved.find((x) => x.template)?.template;

		const tags = Array.from(new Set(resolved.flatMap((x) => x.template?.tags ?? []))).sort();
		const technologies = Array.from(
			new Set(resolved.flatMap((x) => x.template?.technologies ?? [])),
		).sort();

		return {
			title: entry.data.title,
			description: entry.data.description,
			href,
			primaryTemplate: primary
				? { name: primary.name, displayName: primary.displayName, noFrontend: primary.noFrontend }
				: undefined,
			templates: resolved.map((x) => ({ name: x.name, displayName: x.displayName })),
			tags,
			technologies,
		};
	})
	.sort((a, b) => a.title.localeCompare(b.title));

const allTags = Array.from(new Set(pages.flatMap((p) => p.tags))).sort();
const allTechnologies = Array.from(new Set(pages.flatMap((p) => p.technologies))).sort();
---

<MarketingLayout
	title="Cookbook - Rivet"
	description="Step-by-step guides that link to working Rivet templates and example code."
	canonicalUrl="https://rivet.dev/cookbook/"
>
	<CookbookPageContent pages={pages} allTags={allTags} allTechnologies={allTechnologies} client:load />
</MarketingLayout>
