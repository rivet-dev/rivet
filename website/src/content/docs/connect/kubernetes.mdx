# Deploying to Kubernetes
#
Run your backend on any Kubernetes cluster with a simple container image and deployment manifest.

## Guide

<Steps>
<Step title="Prerequisites">

- A Kubernetes cluster with `kubectl` access (AKS, EKS, GKE, k3s, etc.)
- Container registry credentials (Docker Hub, GHCR, GCR, etc.)
- Your backend application repository

</Step>
<Step title="Generate Environment Variables">

Navigate to Rivet and click _Connect > Manual_. Copy the environment variables provided, they will be used in later manifests. You can use either the unified endpoint format or separate variables:

**Unified Format (Recommended):**
```bash
RIVET_ENDPOINT=https://your-namespace-id:your-token@api-us-west-1.rivet.dev
```

**Separate Variables:**
```bash
RIVET_ENDPOINT=https://api-us-west-1.rivet.dev
RIVET_NAMESPACE=your-namespace-id
RIVET_TOKEN=your-token
```

</Step>
<Step title="Package Your App">

Create a `Dockerfile` in your project root:

```dockerfile
FROM node:20-alpine
WORKDIR /app
COPY package*.json ./
RUN npm ci --omit=dev
COPY . .
ENV PORT=8080
CMD ["node", "server.js"]
```

</Step>
<Step title="Build and Push the Image">

```bash
docker build -t registry.example.com/your-team/backend:latest .
docker push registry.example.com/your-team/backend:latest
```

Replace `registry.example.com/your-team` with your registry path. Auth with `docker login` first if needed.

</Step>
<Step title="Deploy to Kubernetes">

Create a `backend-secrets.yaml` for your environment variables:

**With Unified Format (Recommended):**
```yaml
apiVersion: v1
kind: Secret
metadata:
  name: backend-secrets
type: Opaque
stringData:
  RIVET_ENDPOINT: https://your-namespace-id:your-token@api-us-west-1.rivet.dev
```

**Or With Separate Variables:**
```yaml
apiVersion: v1
kind: Secret
metadata:
  name: backend-secrets
type: Opaque
stringData:
  RIVET_ENDPOINT: https://api-us-west-1.rivet.dev
  RIVET_NAMESPACE: your-namespace-id
  RIVET_TOKEN: your-token
```

Then create a `deployment.yaml`:

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: backend
  template:
    metadata:
      labels:
        app: backend
    spec:
      containers:
        - name: backend
          image: registry.example.com/your-team/backend:latest
          envFrom:
            - secretRef:
                name: backend-secrets
```

<Note>You do not need to expose a container port. Rivet tunnels traffic directly to your backend.</Note>

Apply both manifests:

```bash
kubectl apply -f backend-secrets.yaml
kubectl apply -f deployment.yaml
```

Add a `Service` or Ingress if you need external access.

</Step>
<Step title="Verify the Runner">

Check that the pod is running:

```bash
kubectl get pods -l app=backend
```

Your runner should appear as connected on the Rivet dashboard once the pod is ready.

</Step>
</Steps>
